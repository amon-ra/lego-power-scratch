# lego-power-scratch
A script that allows controlling Lego power functions from the Scratch programming environment.  Here is how to use it.


## Hardware
* Use [Alex Bain's schematic and instructions](http://alexba.in/blog/2013/03/09/raspberrypi-ir-schematic-for-lirc/)

## LIRC installation and configuration
* Install [LIRC](http://www.lirc.org/)
```
sudo apt-get install lirc
```

* Configure LIRC by editing `/etc/lirc/hardware.conf` to be
```
#Try to load appropriate kernel modules
LOAD_MODULES=true

# Run "lircd --driver=help" for a list of supported drivers.
DRIVER="default"
# usually /dev/lirc0 is the correct setting for systems using udev
DEVICE="/dev/lirc0"
MODULES="lirc_rpi"
```
* Add in `/etc/modules` the following line
```
lirc_dev
```
* For kernels before 3.18 lacking a "device tree" also add in `/etc/modules` the following line
```
lirc_rpi gpio_in_pin=23 gpio_out_pin=22
```
* For a 3.18 kernel (or newer), which has a [device tree](https://www.raspberrypi.org/forums/viewtopic.php?t=97314), uncomment and adjust the following line in the file `/boot/config.txt`; you can find full instructions [here](https://github.com/raspberrypi/firmware/blob/master/boot/overlays/README)
```
dtoverlay=lirc-rpi,gpio_out_pin=22,gpio_in_pin=23
```

* Copy the PWM command configurations generated by [this modified PWM generation program](https://github.com/dspinellis/lego-lirc) file to the Raspberry Pi's LIRC configuration directory.
```
sudo mkdir -p /etc/lirc/lircd.conf.d/
for i in Single_Output Combo_PWM Combo_Direct ; do
  curl https://raw.githubusercontent.com/dspinellis/lego-lirc/master/$i |
  sudo dd of=/etc/lirc/lircd.conf.d/Lego-$i.conf
done

sudo dd of=/etc/lirc/lircd.conf <<\EOF
# This file is not required in modern versions of LIRC
# but seems to be required for lircd 0.9.0-pre1 that currently
# comes with Raspberry Pi's Debian GNU/Linux 7.8 (wheezy)

include "/etc/lirc/lircd.conf.d/Lego-Single_Output.conf"
include "/etc/lirc/lircd.conf.d/Lego-Combo_Direct.conf"
include "/etc/lirc/lircd.conf.d/Lego-Combo_PWM.conf"
EOF
```
* Reboot your pi

* Test  the sending of Lego commands from the command line.
```
irsend SEND_ONCE LEGO_Single_Output 1B_5
sleep 1
irsend SEND_ONCE LEGO_Single_Output 1B_M1
sleep 1
irsend SEND_ONCE LEGO_Single_Output 1B_BRAKE
```


## Interfacing with Scratch</h2>
* [Enable](http://wiki.scratch.mit.edu/wiki/Remote_Sensor_Connections) remote sensor connections in Scratch.
* Installed Phillip Quiza's [scratchpy library](https://github.com/pilliq/scratchpy)
```
sudo apt-get install python-setuptools
sudo easy_install scratchpy
```
* Use this repo's  Python script that receives Scratch broadcast messages specifying Lego remote commands, and runs the LIRC command-line client to send them.
* Run  the script 
```
python control.py
```
* To use the script from another computer, specify the other computer's address
```
# With IP address
python control.py 192.168.1.12
# With host name
python control.py my-scratch-running-desktop
```

## Programming Scratch</h2>
To send Lego remote control commands from the Scratch environment, use the "broadcast" control message.
Compose a new message of the following form:
```
Lego channel# Blue/Red power
```
where
 * the channel number is an integer from 1 to 4</li>
 * "Blue" or "Red" denotes the corresponding colored side of the receiver block
 * Power is an integer from -7 to 7 or the string "brake"
